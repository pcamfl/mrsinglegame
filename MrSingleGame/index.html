<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mr Single goes on duty</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            margin: 0; padding: 0; background-color: #2c3e50;
            font-family: 'Verdana', sans-serif; overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center; height: 100vh; color: white;
        }
        #game-container {
            position: relative; width: 100%; max-width: 800px; aspect-ratio: 16/9;
            background-color: #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* Animations */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .screen-shake { animation: shake 0.5s; animation-iteration-count: 1; }
        
        /* UI Overlays */
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.3); pointer-events: none; opacity: 0; transition: opacity 0.1s;
        }
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        /* HUD */
        #hud {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0px black;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .hud-group { display: flex; gap: 25px; align-items: center; }
        .hud-item { display: flex; align-items: center; gap: 10px; }
        /* Larger icons in HUD */
        .hud-icon { width: 50px; height: 50px; object-fit: contain; filter: drop-shadow(2px 2px 0 black); }
        #lives-display { display: flex; gap: 5px; }
        .heart-icon { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(2px 2px 0 black); }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: auto; text-align: center; z-index: 20;
            overflow-y: auto; 
        }
        .hidden { display: none !important; }

        h1 { color: #f1c40f; margin-bottom: 10px; font-size: 2rem; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #bdc3c7; max-width: 80%; margin: 5px auto; line-height: 1.5; font-size: 1rem; }
        
        /* Character Previews for Screens */
        .char-preview {
            width: 128px; height: 128px;
            background-image: url('assets/mrsingle.PNG');
            background-size: 300% 300%; /* 3x3 Sprite Sheet */
            image-rendering: pixelated;
            margin: 20px auto;
            border-radius: 10px;
            border: 4px solid #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            background-color: #87CEEB; /* Sky blue background */
        }
        /* Jump Frame: Row 2 (Bottom), Col 1 (Middle) -> 50% 100% */
        .preview-jump { background-position: 50% 100%; }
        /* Walk Frame: Row 0 (Top), Col 1 (Middle) -> 50% 0% */
        .preview-walk { background-position: 50% 0%; }

        /* Topic Buttons Grid - Compact for Start Menu */
        #topic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px; /* Smaller gap */
            width: 90%;
            max-width: 550px;
            margin-top: 5px;
            max-height: 55vh; /* Prevent overflow */
            overflow-y: auto;
            padding: 5px;
        }

        .topic-btn {
            background-color: #e74c3c; color: white; border: none; 
            padding: 8px; /* Smaller padding */
            font-size: 14px; /* Smaller font */
            border-radius: 6px; cursor: pointer;
            transition: all 0.1s; font-weight: bold; border-bottom: 3px solid #c0392b;
            width: 100%;
        }
        .topic-btn:active { transform: scale(0.96); border-bottom: 0; margin-top: 3px; }
        
        /* Start Menu Keyboard Selection */
        .topic-btn.menu-selected {
            background-color: #f1c40f;
            color: #2c3e50;
            border-bottom: 3px solid #d35400;
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }

        /* General Buttons */
        button {
            background-color: #e74c3c; color: white; border: none; padding: 10px;
            font-size: 15px; border-radius: 8px; cursor: pointer;
            transition: transform 0.1s; font-weight: bold; border-bottom: 4px solid #c0392b;
        }
        
        #loading-bar-container {
            width: 60%; height: 20px; background: #333; border: 2px solid white;
            border-radius: 10px; margin-top: 20px; overflow: hidden;
        }
        #loading-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.2s; }

        /* Quiz */
        #quiz-modal {
            background: white; color: #2c3e50; padding: 20px; border-radius: 20px;
            width: 90%; max-width: 650px; text-align: center; pointer-events: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #quiz-timer-container {
            width: 100%; height: 12px; background: #ecf0f1; margin-bottom: 10px; 
            border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        #quiz-timer-bar {
            width: 100%; height: 100%; background: #e74c3c; 
            transition: width 0.1s linear;
        }

        #answers-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columns for 4 answers */
            gap: 10px;
        }

        .answer-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; margin: 0; 
            background-color: #34495e; /* Dark Blue Default */
            border: 4px solid transparent; /* Placeholder for border */
            border-bottom: 5px solid #2c3e50; 
            padding: 10px; font-size: 18px; color: white; border-radius: 8px;
            white-space: normal; transition: all 0.1s; min-height: 60px;
        }
        
        /* Style for keyboard selection - Big Black Border */
        .answer-btn.selected {
            background-color: #f1c40f; /* Yellow focus state */
            color: black;
            border: 4px solid black; /* Big black border */
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        /* Correct/Wrong States */
        .answer-btn.correct-reveal {
            background-color: #27ae60 !important; /* Green */
            border-color: #2ecc71 !important;
            color: white !important;
            transform: scale(1.05);
        }
        .answer-btn.wrong-reveal {
            background-color: #c0392b !important; /* Red */
            border-color: #e74c3c !important;
            opacity: 0.8;
        }
        
        /* Controls */
        #controls {
            display: flex; justify-content: space-between; padding: 20px; pointer-events: auto; padding-bottom: 40px;
        }
        .control-btn {
            width: 75px; height: 75px; background: rgba(255, 255, 255, 0.2); border-radius: 50%;
            border: 3px solid white; display: flex; justify-content: center; align-items: center;
            font-size: 35px; user-select: none; backdrop-filter: blur(4px);
        }
        @media (max-width: 600px) { 
            h1 { font-size: 1.5rem; } .control-btn { width: 60px; height: 60px; }
            #hud { font-size: 18px; }
            #topic-grid { grid-template-columns: 1fr; gap: 6px; } 
            button { padding: 10px; font-size: 14px; }
            #answers-container { grid-template-columns: 1fr; } /* Stack on mobile */
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="damage-overlay"></div>

    <div class="ui-layer">
        <div id="hud">
            <div class="hud-group">
                <!-- Simplified Score: Just the cleaning icon and the count -->
                <div class="hud-item">
                    <img src="assets/litter.PNG" class="hud-icon" style="object-fit: cover; object-position: 0 0;" onerror="this.style.display='none'">
                    <span style="color: #f1c40f;">Level Goal:</span>
                    <span id="cleaned-count" style="color: #2ecc71; font-size: 28px;">0/3</span>
                </div>
            </div>
            <div id="lives-display"></div>
        </div>
        <div id="controls">
            <div id="dpad">
                <div class="control-btn" id="btn-left">←</div>
                <div class="control-btn" id="btn-right">→</div>
            </div>
            <div class="control-btn" id="btn-jump">↑</div>
        </div>
    </div>

    <div id="loading-screen" class="screen">
        <h1>Loading Assets...</h1>
        <div id="loading-bar-container"><div id="loading-bar"></div></div>
    </div>

    <div id="start-screen" class="screen hidden">
        <!-- Enlarged Logo -->
        <img src="assets/homewoodlogo.png" style="max-height: 150px; margin-bottom: 10px;" onerror="this.style.display='none'">
        <h1>Mr Single goes on duty</h1>
        <p>Select a topic to revise:</p>
        <p style="font-size:0.8rem; color:#bdc3c7;">(Use Arrows & Enter to select)</p>
        <div id="topic-grid">
            <!-- Added IDs and class for keyboard navigation -->
            <button class="topic-btn" id="btn-topic-0" onclick="startGame('school')">School & Education</button>
            <button class="topic-btn" id="btn-topic-1" onclick="startGame('freetime')">Free Time & Media</button>
            <button class="topic-btn" id="btn-topic-2" onclick="startGame('family')">Family & Relationships</button>
            <button class="topic-btn" id="btn-topic-3" onclick="startGame('health')">Health & Fitness</button>
            <button class="topic-btn" id="btn-topic-4" onclick="startGame('home')">Home & Local Area</button>
            <button class="topic-btn" id="btn-topic-5" onclick="startGame('holidays')">Holidays & Travel</button>
            <button class="topic-btn" id="btn-topic-6" onclick="startGame('world')">Our World & Environment</button>
            <button class="topic-btn" id="btn-topic-7" onclick="startGame('future')">Future Plans & Work</button>
        </div>
    </div>

    <div id="quiz-screen" class="screen hidden" style="background: rgba(0,0,0,0.85);">
        <div id="quiz-modal">
            <div id="quiz-timer-container">
                <div id="quiz-timer-bar"></div>
            </div>
            <h3>Translate:</h3>
            <h2 id="question-text" style="color: #e74c3c; font-size: 2rem; margin: 15px 0;">Haus</h2>
            <div id="answers-container"></div>
            <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">(Use Arrow Keys & Enter)</p>
        </div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #e74c3c">Mission Failed</h1>
        <!-- Jump Decoration -->
        <div class="char-preview preview-jump"></div>
        <p>You cleaned <span id="final-cleaned" style="color: #2ecc71; font-weight: bold; font-size: 1.5rem;">0</span> items!</p>
        <button onclick="resetGame()" style="margin-top: 20px;">Try Again</button>
    </div>
    
    <div id="level-screen" class="screen hidden">
        <h1 style="color: #2ecc71">Day Complete!</h1>
        <!-- Walk Decoration -->
        <div class="char-preview preview-walk"></div>
        <p>Excellent work, Sir.</p>
        <p style="color: #f1c40f; font-size: 0.9rem; margin-top: 5px;">(+1 Life Awarded!)</p>
        <button onclick="nextLevel()">Start Next Day (Enter)</button>
    </div>
</div>

<script>
/* --- ASSETS CONFIG --- */
const ASSETS = {
    player: "assets/mrsingle.PNG",      
    litter: "assets/litter.PNG",        
    uniform: "assets/uniform.PNG",      
    background: "assets/background.png",
    seagull: "assets/seagull.png",
    heart: "assets/heart.png",
    scenery: [
        "assets/3gpitch.png", "assets/ablock.png", "assets/tblock.png", "assets/gblock.png",
        "assets/mansion.png", "assets/pioneer.png", "assets/endeavour.png", "assets/fortitude.png",
        "assets/quest.png", "assets/voyager.png", "assets/sindenlogo.png", "assets/homewoodlogo.png"
    ]
};

/* --- VOCABULARY DATABASE --- */
const VOCAB_DB = {
    school: [
        ["der Computer", "Computer"], ["der Kuli", "Pen"], ["die Schultasche", "School bag"], ["das Buch", "Textbook"], ["das Heft", "Exercise book"],
        ["die Biologie", "Biology"], ["die Chemie", "Chemistry"], ["die Kunst", "Art"], ["das Mathe", "Maths"], ["die Musik", "Music"],
        ["der Stundenplan", "Timetable"], ["die Pause", "Break"], ["die Hausaufgaben", "Homework"], ["die Schuluniform", "School uniform"], ["die Krawatte", "Tie"],
        ["das Hemd", "Shirt"], ["der Rock", "Skirt"], ["die Hose", "Trousers"], ["die Schuhe", "Shoes"], ["der Lehrer", "Teacher"],
        ["die Lehrerin", "Female teacher"], ["das Fach", "Subject"], ["einfach", "Easy"], ["schwer", "Difficult"], ["nützlich", "Useful"],
        ["die Wasserflasche", "Water bottle"], ["die Naturwissenschaften", "Sciences"], ["die Geschichte", "History"], ["die Erdkunde", "Geography"], ["das Theater", "Drama"],
        ["die Sprachen", "Languages"], ["die Informatik", "Computing"], ["die Religion", "Religious Education"], ["der Montag", "Monday"], ["der Dienstag", "Tuesday"],
        ["der Mittwoch", "Wednesday"], ["der Donnerstag", "Thursday"], ["der Freitag", "Friday"], ["die Stunde", "Lesson"], ["ermüdend", "Tiring"],
        ["interessant", "Interesting"], ["kompliziert", "Complicated"], ["langweilig", "Boring"], ["leicht", "Easy"], ["praktisch", "Practical"],
        ["der Pullover", "Sweater"], ["die Jacke", "Jacket"], ["das Kleid", "Dress"], ["blau", "Blue"], ["grün", "Green"]
    ],
    freetime: [
        ["die Musik", "Music"], ["das Einkaufen", "Shopping"], ["das Fernsehen", "TV"], ["das Lesen", "Reading"], ["das Radfahren", "Cycling"],
        ["der Sport", "Sport"], ["das Kino", "Cinema"], ["das Schwimmen", "Swimming"], ["das Wandern", "Hiking"], ["das Konzert", "Concert"],
        ["das Wochenende", "Weekend"], ["die Nachrichten", "News"], ["das Handy", "Mobile phone"], ["der Film", "Film"], ["die Sendung", "Programme"],
        ["langweilig", "Boring"], ["spannend", "Exciting"], ["lustig", "Funny"], ["täglich", "Daily"], ["manchmal", "Sometimes"],
        ["die Karte", "Ticket"], ["der Schauspieler", "Actor"], ["singen", "To sing"], ["tanzen", "To dance"], ["malen", "To paint"],
        ["Rockmusik", "Rock music"], ["Popmusik", "Pop music"], ["klassische Musik", "Classical music"], ["das Hobby", "Hobby"], ["die Freizeit", "Free time"],
        ["Gaming", "Gaming"], ["fotografieren", "Taking photos"], ["der Computer", "Computer"], ["der Laptop", "Laptop"], ["die Spielkonsole", "Games console"],
        ["das Tablet", "Tablet"], ["herunterladen", "To download"], ["hochladen", "To upload"], ["soziale Medien", "Social media"], ["chatten", "To chat"],
        ["streamen", "To stream"], ["die Ausstellung", "Exhibition"], ["die Vorstellung", "Performance"], ["das Theater", "Theatre"], ["das Museum", "Museum"],
        ["der Krimi", "Thriller"], ["die Komödie", "Comedy"], ["die Serie", "Series"], ["die Gewalt", "Violence"]
    ],
    family: [
        ["die Familie", "Family"], ["der Bruder", "Brother"], ["die Schwester", "Sister"], ["die Eltern", "Parents"], ["der Vater", "Father"],
        ["die Mutter", "Mother"], ["die Großeltern", "Grandparents"], ["der Onkel", "Uncle"], ["die Tante", "Aunt"], ["der Freund", "Male friend"],
        ["die Freundin", "Female friend"], ["die Beziehung", "Relationship"], ["das Vorbild", "Role model"], ["glücklich", "Happy"], ["traurig", "Sad"],
        ["freundlich", "Friendly"], ["streng", "Strict"], ["ehrlich", "Honest"], ["das Fest", "Festival"], ["der Geburtstag", "Birthday"],
        ["feiern", "To celebrate"], ["lachen", "To laugh"], ["helfen", "To help"], ["diskutieren", "To discuss"], ["besuchen", "To visit"],
        ["der Markt", "Market"], ["teuer", "Expensive"], ["toll", "Great"], ["laut", "Loud"], ["der Weihnachtsmarkt", "Christmas market"],
        ["das Kaninchen", "Rabbit"], ["die Geschwister", "Siblings"], ["die Haare", "Hair"], ["die Augen", "Eyes"], ["kurz", "Short"],
        ["lang", "Long"], ["groß", "Tall/Big"], ["klein", "Small"], ["sportlich", "Sporty"], ["die Brille", "Glasses"],
        ["verstehen", "To get on with"], ["die Stiefmutter", "Stepmother"], ["aktiv", "Active"], ["böse", "Angry"], ["ernst", "Serious"],
        ["fleißig", "Hard-working"], ["locker", "Relaxed"], ["unabhängig", "Independent"], ["neulich", "Recently"], ["unterstützen", "To support"]
    ],
    health: [
        ["die Gesundheit", "Health"], ["der Körper", "Body"], ["der Kopf", "Head"], ["der Bauch", "Stomach"], ["der Arm", "Arm"],
        ["das Bein", "Leg"], ["der Fuß", "Foot"], ["die Hand", "Hand"], ["das Auge", "Eye"], ["der Mund", "Mouth"],
        ["die Schmerzen", "Pains/Aches"], ["krank", "Ill/Sick"], ["gesund", "Healthy"], ["müde", "Tired"], ["fit", "Fit"],
        ["das Essen", "Food"], ["das Trinken", "Drink"], ["das Obst", "Fruit"], ["das Gemüse", "Vegetables"], ["das Wasser", "Water"],
        ["der Arzt", "Doctor"], ["das Krankenhaus", "Hospital"], ["laufen", "To run"], ["schlafen", "To sleep"], ["vermeiden", "To avoid"],
        ["regelmäßig", "Regularly"], ["häufig", "Frequently"], ["selten", "Rarely"], ["das Schwimmbad", "Swimming pool"], ["der Löffel", "Spoon"],
        ["der Teller", "Plate"], ["die Flasche", "Bottle"], ["die Gabel", "Fork"], ["das Glas", "Glass"], ["das Messer", "Knife"],
        ["die Rechnung", "Bill"], ["bezahlen", "To pay"], ["der Hals", "Throat/Neck"], ["der Finger", "Finger"], ["der Rücken", "Back"],
        ["der Zahn", "Tooth"], ["die Haut", "Skin"], ["die Nase", "Nose"], ["die Schulter", "Shoulder"], ["das Gesicht", "Face"],
        ["das Herz", "Heart"], ["das Knie", "Knee"], ["das Ohr", "Ear"], ["verletzt", "Injured"], ["das Bett", "Bed"]
    ],
    home: [
        ["das Haus", "House"], ["die Wohnung", "Flat/Apartment"], ["das Zimmer", "Room"], ["die Küche", "Kitchen"], ["das Schlafzimmer", "Bedroom"],
        ["das Wohnzimmer", "Living room"], ["das Badezimmer", "Bathroom"], ["der Garten", "Garden"], ["die Stadt", "Town/City"], ["das Dorf", "Village"],
        ["die Gegend", "Area"], ["der Laden", "Shop"], ["der Markt", "Market"], ["die Post", "Post office"], ["die Bank", "Bank"],
        ["der Bahnhof", "Train station"], ["die Kirche", "Church"], ["der Park", "Park"], ["ruhig", "Quiet"], ["laut", "Noisy"],
        ["schön", "Beautiful"], ["hässlich", "Ugly"], ["groß", "Big"], ["klein", "Small"], ["wohnen", "To live"],
        ["Deutschland", "Germany"], ["Österreich", "Austria"], ["die Schweiz", "Switzerland"], ["der Fluss", "River"], ["die Hauptstadt", "Capital city"],
        ["das Land", "Country"], ["die Kleinstadt", "Small town"], ["die Großstadt", "City"], ["die Stadtmitte", "Town centre"], ["die Berge", "Mountains"],
        ["der Stadtrand", "Outskirts"], ["der See", "Lake"], ["die Küste", "Coast"], ["der Norden", "North"], ["der Osten", "East"],
        ["der Süden", "South"], ["der Westen", "West"], ["alt", "Old"], ["neu", "New"], ["sauber", "Clean"],
        ["schmutzig", "Dirty"], ["modern", "Modern"], ["sicher", "Safe"], ["der Flughafen", "Airport"], ["die Bibliothek", "Library"]
    ],
    holidays: [
        ["die Ferien", "Holidays"], ["der Urlaub", "Holiday/Vacation"], ["die Reise", "Journey"], ["das Flugzeug", "Plane"], ["der Zug", "Train"],
        ["das Auto", "Car"], ["der Bus", "Bus"], ["das Hotel", "Hotel"], ["der Strand", "Beach"], ["das Meer", "Sea"],
        ["die Sonne", "Sun"], ["der Regen", "Rain"], ["der Schnee", "Snow"], ["heiß", "Hot"], ["kalt", "Cold"],
        ["der Koffer", "Suitcase"], ["der Pass", "Passport"], ["besichtigen", "To visit (sights)"], ["bleiben", "To stay"], ["fahren", "To travel/drive"],
        ["fliegen", "To fly"], ["schwimmen", "To swim"], ["sonnenbaden", "To sunbathe"], ["wandern", "To hike"], ["kaufen", "To buy"],
        ["beliebt", "Popular"], ["berühmt", "Famous"], ["historisch", "Historic"], ["traditionell", "Traditional"], ["unglaublich", "Incredible"],
        ["wunderbar", "Wonderful"], ["der Berg", "Mountain"], ["der Wald", "Forest"], ["das Schloss", "Castle"], ["die Idee", "Idea"],
        ["günstig", "Cheap"], ["die Reservierung", "Reservation"], ["das Einzelzimmer", "Single room"], ["das Doppelzimmer", "Double room"], ["das Bad", "Bath"],
        ["die Nacht", "Night"], ["die Woche", "Week"], ["ankommen", "To arrive"], ["abfahren", "To depart"], ["die Kreditkarte", "Credit card"],
        ["der Schlüssel", "Key"], ["die Tasche", "Bag"], ["das Gepäck", "Luggage"], ["vergessen", "To forget"], ["verloren", "Lost"]
    ],
    world: [
        ["die Welt", "The world"], ["die Umwelt", "Environment"], ["das Problem", "Problem"], ["der Müll", "Rubbish/Waste"], ["das Plastik", "Plastic"],
        ["das Wasser", "Water"], ["die Luft", "Air"], ["verschmutzt", "Polluted"], ["sauber", "Clean"], ["schützen", "To protect"],
        ["recyceln", "To recycle"], ["sparen", "To save"], ["die Energie", "Energy"], ["der Strom", "Electricity"], ["das Tier", "Animal"],
        ["arm", "Poor"], ["reich", "Rich"], ["helfen", "To help"], ["spenden", "To donate"], ["wichtig", "Important"],
        ["global", "Global"], ["international", "International"], ["die Lösung", "Solution"], ["die Zukunft", "Future"], ["verändern", "To change"],
        ["der Beruf", "Job"], ["der Erfolg", "Success"], ["der Fortschritt", "Progress"], ["der Mensch", "Person"], ["der Zweck", "Purpose"],
        ["die Diskriminierung", "Discrimination"], ["die Erfahrung", "Experience"], ["die Herkunft", "Origin"], ["das Leben", "Life"], ["das Ziel", "Goal"],
        ["entwickeln", "To develop"], ["gründen", "To found"], ["informieren", "To inform"], ["kämpfen", "To fight"], ["schwarz", "Black"],
        ["gegen", "Against"], ["trotz", "Despite"], ["während", "During"], ["wegen", "Because of"], ["die Angst", "Fear"],
        ["zufrieden", "Satisfied"], ["die Sorge", "Worry"], ["der Hunger", "Hunger"], ["die Arbeit", "Work"], ["die Familie", "Family"]
    ],
    future: [
        ["die Zukunft", "Future"], ["der Plan", "Plan"], ["der Beruf", "Job/Profession"], ["die Arbeit", "Work"], ["das Studium", "Studies"],
        ["die Universität", "University"], ["die Schule", "School"], ["das Abitur", "A-levels"], ["die Ausbildung", "Apprenticeship/Training"], ["das Geld", "Money"],
        ["verdienen", "To earn"], ["werden", "To become"], ["möchten", "To would like"], ["wollen", "To want"], ["hoffen", "To hope"],
        ["reisen", "To travel"], ["heiraten", "To marry"], ["Kinder", "Children"], ["erfolgreich", "Successful"], ["glücklich", "Happy"],
        ["der Traum", "Dream"], ["das Ziel", "Goal"], ["das Ausland", "Abroad"], ["die Sprache", "Language"], ["lernen", "To learn"],
        ["helfen", "To help"], ["vorhaben", "To intend"], ["planen", "To plan"], ["entscheiden", "To decide"], ["bereit", "Ready"],
        ["der Sommer", "Summer"], ["das Jahr", "Year"], ["später", "Later"], ["die Prüfung", "Exam"], ["studieren", "To study"],
        ["arbeiten", "To work"], ["kennenlernen", "To get to know"], ["der Abschluss", "Qualification"], ["finden", "To find"], ["wissen", "To know"],
        ["sicher", "Sure/Certain"], ["schlafen", "To sleep"], ["nichts", "Nothing"], ["entspannen", "To relax"], ["die Oberstufe", "Sixth form"],
        ["interessieren", "To be interested"], ["bleiben", "To stay"], ["der Kontakt", "Contact"], ["suchen", "To search"], ["praktisch", "Practical"]
    ]
};

/* --- GENERATOR --- */
function generateRandomQuestion(topicKey) {
    const list = VOCAB_DB[topicKey] || VOCAB_DB['school'];
    const correctPair = list[Math.floor(Math.random() * list.length)];
    
    let inverseChance = Math.min((level - 1) * 0.2, 1.0);
    if (inverseChance < 0) inverseChance = 0;
    
    const isInverse = Math.random() < inverseChance;
    
    let q, a, correctIndex, wrongIndex;
    
    if (!isInverse) {
        // Standard: German -> English
        q = correctPair[0]; // German
        a = correctPair[1]; // English
        correctIndex = 1;
        wrongIndex = 1; // Pick English distractors
    } else {
        // Inverse: English -> German
        q = correctPair[1]; // English
        a = correctPair[0]; // German
        correctIndex = 0;
        wrongIndex = 0; // Pick German distractors
    }
    
    const allAnswers = list.map(pair => pair[wrongIndex]);
    
    let w1, w2, w3;
    do { w1 = allAnswers[Math.floor(Math.random() * allAnswers.length)]; } while (w1 === a);
    do { w2 = allAnswers[Math.floor(Math.random() * allAnswers.length)]; } while (w2 === a || w2 === w1);
    do { w3 = allAnswers[Math.floor(Math.random() * allAnswers.length)]; } while (w3 === a || w3 === w1 || w3 === w2);
    
    return { q: q, a: a, w: [w1, w2, w3] };
}

/* --- LOADER --- */
const images = {};
const sceneryImages = [];
let loadedCount = 0;
const totalToLoad = Object.keys(ASSETS).length - 1 + ASSETS.scenery.length; 

// Failsafe timer
setTimeout(() => {
    if (loadedCount < totalToLoad) {
        console.warn("Asset loading timed out. Forcing start.");
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        renderMenuSelection(); // Ensure selection starts
    }
}, 3000);

function loadGame() {
    for (let key in ASSETS) {
        if (key === 'scenery') continue;
        loadImage(key, ASSETS[key]);
    }
    ASSETS.scenery.forEach(src => {
        const img = new Image();
        img.src = src;
        img.onload = () => { if (img.naturalWidth > 0) sceneryImages.push(img); onAssetLoad(); };
        img.onerror = () => { console.warn("Skipped: " + src); onAssetLoad(); };
    });
}

function loadImage(key, src) {
    const img = new Image();
    img.src = src;
    img.onload = () => {
        images[key] = img;
        onAssetLoad();
    };
    img.onerror = () => {
        console.warn("Failed to load: " + src);
        images[key] = new Image(); 
        onAssetLoad();
    };
}

function onAssetLoad() {
    loadedCount++;
    const pct = Math.floor((loadedCount / totalToLoad) * 100);
    document.getElementById('loading-bar').style.width = pct + "%";
    if (loadedCount >= totalToLoad) {
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            renderMenuSelection();
        }, 500);
    }
}

/* --- VARS --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameState = 'MENU';
let currentTopic = 'school';
let lives = 3, level = 1, frames = 0, cameraX = 0;
let itemsCleaned = 0; 
let levelProgress = 0; // Tracks progress within level
let levelTarget = 3;   // Target for current level

let keys = { ArrowRight: false, ArrowLeft: false, ArrowUp: false };
let gameLoopId = null; 
let gracePeriod = 0;

// Start Menu Selection
let menuSelectionIndex = 0;
const TOPICS_LIST = ['school', 'freetime', 'family', 'health', 'home', 'holidays', 'world', 'future'];

// Quiz Vars
let quizTimer = 0;
const QUIZ_MAX_TIME = 450; // Approx 7.5 seconds
let quizSelectionIndex = 0;
let currentQuizAnswers = [];
let quizLocked = false; 

const GRAVITY = 0.6, FRICTION = 0.8, JUMP_STRENGTH = -12, SPEED = 5;

let player, platforms = [], enemies = [], bgObjects = [], seagullAttack = null;
let pendingEnemy = null;

function resizeCanvas() { canvas.width = 800; canvas.height = 450; }
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

/* --- ENTITY CLASSES --- */

class Player {
    constructor() {
        this.width = 64; this.height = 64; 
        this.x = 100; this.y = 300;
        this.velX = 0; this.velY = 0;
        this.grounded = false; this.facingRight = true;
        this.invulnerable = 180; 
        this.animFrame = 0; this.animTimer = 0; this.state = 'IDLE';
    }

    update() {
        if (this.invulnerable > 0) this.invulnerable--;
        if (!Number.isFinite(this.x)) this.x = 100;

        if (gameState === 'PLAYING') {
            if (keys.ArrowRight) { if (this.velX < SPEED) this.velX++; this.facingRight = true; }
            if (keys.ArrowLeft) { if (this.velX > -SPEED) this.velX--; this.facingRight = false; }
            if (keys.ArrowUp && this.grounded) { this.velY = JUMP_STRENGTH; this.grounded = false; }
        }

        if (!this.grounded) this.state = 'JUMP';
        else if (Math.abs(this.velX) > 0.5) this.state = 'WALK';
        else this.state = 'IDLE';

        this.animTimer++;
        if (this.animTimer > 8) { this.animTimer = 0; this.animFrame++; }

        this.velX *= FRICTION; this.velY += GRAVITY;
        this.x += this.velX; this.y += this.velY;

        if (this.x < 0) { this.x = 0; this.velX = 0; }
        
        // Floor Collision
        if (this.y + this.height > canvas.height - 40) {
            this.y = canvas.height - 40 - this.height; this.velY = 0; this.grounded = true;
        } else {
            this.grounded = false;
        }

        platforms.forEach(plat => {
            if (this.x + 20 < plat.x + plat.w && this.x + this.width - 20 > plat.x &&
                this.y + this.height > plat.y && this.y + this.height < plat.y + plat.h + 10 &&
                this.velY >= 0) {
                    this.y = plat.y - this.height; this.velY = 0; this.grounded = true;
            }
        });
    }

    draw() {
        ctx.save();
        let drawX = Math.floor(this.x - cameraX);
        let drawY = Math.floor(this.y);
        
        if (this.invulnerable > 0) ctx.globalAlpha = 0.5;

        let img = images.player;
        if (img && img.complete && img.naturalWidth > 0) {
            let spriteW = img.width / 3; let spriteH = img.height / 3; 
            let col = 0, row = 0;
            if (this.state === 'IDLE') { col = 0; row = 0; }
            else if (this.state === 'WALK') { row = 0; col = (this.animFrame % 3); }
            else if (this.state === 'JUMP') { row = 2; col = 1; }

            if (!this.facingRight) { ctx.translate(drawX + this.width, drawY); ctx.scale(-1, 1); drawX = 0; drawY = 0; }
            else { ctx.translate(drawX, drawY); drawX = 0; drawY = 0; }

            // Draw Sprite
            ctx.drawImage(img, col * spriteW, row * spriteH, spriteW, spriteH, 0, 0, this.width, this.height);
        } else {
            ctx.fillStyle = '#3498db'; ctx.fillRect(drawX, drawY, this.width, this.height);
        }
        ctx.restore();
    }
}

class Enemy {
    constructor(x, y, category, speedMult) {
        this.x = x; this.y = y; 
        this.category = category;
        
        // --- MODIFIED SIZES ---
        if (this.category === 'litter') {
            // Reduced by 30% (from 100 to 70)
            this.width = 70; 
            this.height = 56; 
        } else {
            // Uniform: Increased by 20% (from 100 to 120)
            this.width = 120;
            this.height = 96;
        }
        
        // Increased padding to reduce hitbox size by 20%
        // Hitbox logic calculates eW = width - (padding*2)
        // We want effective hit area to be smaller.
        this.hitboxPadding = 25; 

        this.speed = (1 + Math.random()) * speedMult; 
        this.direction = -1; 
        this.state = 'ALIVE'; 
        this.dyingTimer = 0;
        this.bounceOffset = Math.random() * Math.PI * 2;
        this.subType = Math.floor(Math.random() * 3); 
        this.velY = 0; this.grounded = false;
    }

    update() {
        if (this.state === 'DYING') {
            this.y += this.velY; this.velY += 0.5; 
            this.dyingTimer++;
            if (this.y > canvas.height) this.state = 'GONE';
            return;
        }

        if (gameState !== 'PLAYING') return;
        
        this.x += this.speed * this.direction;
        if (frames % 120 === 0 && Math.random() > 0.5) this.direction *= -1;
        
        this.velY += GRAVITY; this.y += this.velY;

        // Floor collision
        if (this.y + this.height > canvas.height - 40) {
            this.y = canvas.height - 40 - this.height; this.velY = 0; this.grounded = true;
        } else { this.grounded = false; }

        if (this.category === 'uniform' && this.grounded && Math.random() < 0.02) {
            this.velY = -10; this.grounded = false;
        }
        else if (this.category === 'litter' && this.grounded) {
             this.y += Math.sin(frames * 0.1 + this.bounceOffset) * 0.5;
        }
    }

    draw() {
        if (this.state === 'GONE') return;
        ctx.save();
        let drawX = Math.floor(this.x - cameraX);
        let drawY = Math.floor(this.y);

        if (this.state === 'DYING') {
            ctx.translate(drawX + this.width/2, drawY + this.height/2);
            ctx.rotate(this.dyingTimer * 0.2);
            ctx.translate(-(drawX + this.width/2), -(drawY + this.height/2));
        }

        let img = images[this.category];
        if (img && img.complete && img.naturalWidth > 0) {
            let spriteW = img.width / 3; 
            ctx.drawImage(img, this.subType * spriteW, 0, spriteW, img.height, drawX, drawY, this.width, this.height);
        } else {
            ctx.fillStyle = '#e74c3c'; ctx.fillRect(drawX, drawY, this.width, this.height);
        }
        ctx.restore();
    }
    defeat() { this.state = 'DYING'; this.velY = -10; }
}

class SceneryObject {
    constructor(img, x, y) {
        this.img = img; this.x = x; this.y = y;
        this.scale = 0.5 + Math.random() * 0.5; 
        this.parallax = 0.2 + Math.random() * 0.3; 
    }
    draw() {
        let drawX = this.x - (cameraX * this.parallax);
        if (drawX > -400 && drawX < 1200) {
            if (this.img && this.img.complete && this.img.naturalWidth > 0) {
                let w = this.img.width * this.scale * 0.5; 
                let h = this.img.height * this.scale * 0.5;
                ctx.globalAlpha = 0.8; 
                ctx.drawImage(this.img, drawX, this.y - h, w, h);
                ctx.globalAlpha = 1.0;
            }
        }
    }
}

class Seagull {
    constructor(startX, startY, targetX, targetY) {
        this.x = startX; this.y = startY; 
        this.frame = 0; 
        this.maxFrames = 150; 
        this.speedX = (targetX - startX) / this.maxFrames;
        this.speedY = (targetY - startY) / this.maxFrames;
    }
    update() {
        this.x += this.speedX; this.y += this.speedY; this.frame++;
        if (this.frame >= this.maxFrames) seagullAttack = null;
    }
    draw() {
        ctx.save();
        let drawX = Math.floor(this.x - cameraX);
        let drawY = Math.floor(this.y);
        if (images.seagull && images.seagull.complete && images.seagull.naturalWidth > 0) {
            ctx.drawImage(images.seagull, drawX, drawY, 120, 90);
        }
        ctx.fillStyle = 'black'; ctx.font = "20px Arial"; ctx.fillText("SWOOP!", drawX, drawY - 10);
        ctx.restore();
    }
}

/* --- GAME LOGIC --- */

function startGame(topic) {
    if (gameLoopId) cancelAnimationFrame(gameLoopId);

    currentTopic = topic;
    lives = 3; level = 1; itemsCleaned = 0;
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('level-screen').classList.add('hidden');
    
    loadLevel();
    updateUI();
    
    gracePeriod = 60; 
    gameState = 'PLAYING'; 
    gameLoop(); 
}

function loadLevel() {
    player = new Player(); enemies = []; platforms = []; bgObjects = []; seagullAttack = null; cameraX = 0;
    
    // --- LEVEL CONFIGURATION ---
    levelProgress = 0;
    levelTarget = 1 + (level * 2); 
    let speedMult = 0.6 + (level * 0.2);
    let entityCount = 20 + (level * 10);

    // Generate Scenery
    let sceneryX = 100;
    for (let i=0; i<20; i++) { 
        if (sceneryImages.length > 0) {
            let rndImg = sceneryImages[Math.floor(Math.random() * sceneryImages.length)];
            if (rndImg.naturalWidth > 0) {
                bgObjects.push(new SceneryObject(rndImg, sceneryX, 380)); 
                sceneryX += 300 + Math.random() * 300;
            }
        }
    }

    // Generate Entities
    for (let i = 0; i < entityCount; i++) {
        let pX = i * 250 + 600; 
        
        // Platform probability
        if (i % 2 === 0 || Math.random() < 0.3) { 
            let pW = 100 + Math.random() * 100; 
            let pY = 150 + Math.random() * 200; 
            platforms.push({x: pX, y: pY, w: pW, h: 20});
        }
        
        let ex = pX + 100 + Math.random() * 100;
        let ey = 300;
        let platform = platforms[platforms.length - 1];
        if (platform && Math.random() > 0.5) {
             ex = platform.x + 20; ey = platform.y - 100; 
        }
        
        let cat = Math.random() > 0.5 ? 'litter' : 'uniform';
        enemies.push(new Enemy(ex, ey, cat, speedMult));
    }
    
    updateUI();
}

function checkCollisions() {
    if (!player || gameState !== 'PLAYING') return;
    if (gracePeriod > 0) { gracePeriod--; return; }

    enemies.forEach(enemy => {
        if (enemy.state !== 'ALIVE') return; 
        
        let pX = player.x + 10, pW = player.width - 20, pY = player.y, pH = player.height;
        let eX = enemy.x + enemy.hitboxPadding, eW = enemy.width - (enemy.hitboxPadding * 2);
        let eY = enemy.y + enemy.hitboxPadding, eH = enemy.height - (enemy.hitboxPadding * 2);

        if (pX < eX + eW && pX + pW > eX && pY < eY + eH && pY + pH > eY) {
            let isJumpingOnTop = (player.velY > 0 && (player.y + player.height) < (enemy.y + enemy.height/2 + 20));
            if (isJumpingOnTop) {
                pendingEnemy = enemy; gameState = 'QUIZ'; triggerQuiz(); player.velY = -8;
            } else {
                hurtPlayer(enemy);
            }
        }
    });
}

function hurtPlayer(sourceEnemy) {
    if (player.invulnerable > 0) return;
    
    document.getElementById('game-container').classList.add('screen-shake');
    setTimeout(() => document.getElementById('game-container').classList.remove('screen-shake'), 500);
    
    let overlay = document.getElementById('damage-overlay');
    overlay.style.opacity = "1";
    setTimeout(() => overlay.style.opacity = "0", 200);

    lives--; updateUI();
    if (lives <= 0) { triggerGameOverScreen(); return; }

    let dir = -1; 
    if (sourceEnemy && player.x < sourceEnemy.x) dir = -1;
    else if (sourceEnemy && player.x > sourceEnemy.x) dir = 1;
    
    player.x += dir * 80; player.velY = -5;
    player.invulnerable = 180; 
    // MODIFIED: Seagull attacks from Right to Left to match sprite direction
    seagullAttack = new Seagull(player.x + 400, player.y - 200, player.x - 400, player.y + 100);
}

function triggerGameOverScreen() {
    gameState = 'GAMEOVER';
    document.getElementById('final-cleaned').innerText = itemsCleaned;
    document.getElementById('game-over-screen').classList.remove('hidden');
}

function levelComplete() {
    gameState = 'LEVEL_END';
    lives++; 
    updateUI();
    document.getElementById('level-screen').classList.remove('hidden');
}

/* --- START MENU LOGIC --- */
function changeMenuSelection(dir) {
    if (gameState !== 'MENU') return;
    
    // 2x4 Grid for 8 buttons
    // [0] [1]
    // [2] [3]
    // [4] [5]
    // [6] [7]
    
    if (dir === 'UP') menuSelectionIndex -= 2;
    if (dir === 'DOWN') menuSelectionIndex += 2;
    if (dir === 'LEFT') menuSelectionIndex -= 1;
    if (dir === 'RIGHT') menuSelectionIndex += 1;
    
    // Wrap around bounds
    if (menuSelectionIndex < 0) menuSelectionIndex += 8;
    if (menuSelectionIndex >= 8) menuSelectionIndex -= 8;
    
    renderMenuSelection();
}

function renderMenuSelection() {
    // Clear old selection
    for (let i=0; i<8; i++) {
        document.getElementById('btn-topic-'+i).classList.remove('menu-selected');
    }
    // Add new selection
    const btn = document.getElementById('btn-topic-' + menuSelectionIndex);
    if (btn) {
        btn.classList.add('menu-selected');
        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function confirmMenuSelection() {
    if (gameState !== 'MENU') return;
    let topic = TOPICS_LIST[menuSelectionIndex];
    startGame(topic);
}

/* --- QUIZ LOGIC WITH TIMER & KEYBOARD --- */
function triggerQuiz() {
    keys.ArrowRight = false; keys.ArrowLeft = false; keys.ArrowUp = false;

    const task = generateRandomQuestion(currentTopic);
    document.getElementById('quiz-screen').classList.remove('hidden');
    const container = document.getElementById('answers-container');
    document.getElementById('question-text').innerText = task.q;
    container.innerHTML = '';
    
    quizTimer = QUIZ_MAX_TIME;
    quizSelectionIndex = 0;
    quizLocked = false;
    
    currentQuizAnswers = [
        { t: task.a, c: true }, 
        { t: task.w[0], c: false }, 
        { t: task.w[1], c: false },
        { t: task.w[2], c: false }
    ];
    currentQuizAnswers.sort(() => Math.random() - 0.5);

    renderQuizButtons();
}

function renderQuizButtons() {
    const container = document.getElementById('answers-container');
    container.innerHTML = '';
    
    currentQuizAnswers.forEach((a, index) => {
        let btn = document.createElement('button'); 
        btn.className = 'answer-btn'; 
        if (index === quizSelectionIndex) btn.classList.add('selected');
        
        btn.innerText = a.t;
        
        btn.onclick = () => {
             quizSelectionIndex = index;
             renderQuizButtons(); 
             confirmQuizSelection(); 
        }; 
        container.appendChild(btn);
    });
}

function updateQuizLogic() {
    if (quizLocked) return; 
    quizTimer--;
    let widthPct = (quizTimer / QUIZ_MAX_TIME) * 100;
    document.getElementById('quiz-timer-bar').style.width = widthPct + "%";
    
    if (quizTimer <= 0) {
        handleQuizAnswer(false);
    }
}

function confirmQuizSelection() {
    if (quizLocked) return;
    let selectedAns = currentQuizAnswers[quizSelectionIndex];
    handleQuizAnswer(selectedAns.c);
}

function handleQuizAnswer(isCorrect) {
    if (quizLocked) return;
    quizLocked = true; 

    const container = document.getElementById('answers-container');
    const buttons = container.getElementsByClassName('answer-btn');

    for (let i = 0; i < buttons.length; i++) {
        if (currentQuizAnswers[i].c === true) {
            buttons[i].classList.add('correct-reveal');
        }
    }

    if (!isCorrect) {
        if (buttons[quizSelectionIndex]) {
            buttons[quizSelectionIndex].classList.add('wrong-reveal');
        }
    }

    setTimeout(() => {
        document.getElementById('quiz-screen').classList.add('hidden');
        if (isCorrect) { 
            itemsCleaned++; 
            levelProgress++; // Increment level progress
            if (pendingEnemy) pendingEnemy.defeat(); 
            
            // Check for level completion
            if (levelProgress >= levelTarget) {
                levelComplete();
            }
        } else { 
            hurtPlayer(pendingEnemy); 
        }
        updateUI();
        if (gameState !== 'GAMEOVER' && gameState !== 'LEVEL_END') gameState = 'PLAYING';
    }, 1000);
}

function changeQuizSelection(dir) {
    if (quizLocked) return;

    if (dir === 'UP' || dir === 'DOWN') {
        quizSelectionIndex = (quizSelectionIndex + 2) % 4;
    } 
    else if (dir === 'LEFT' || dir === 'RIGHT') {
        const rowStart = Math.floor(quizSelectionIndex / 2) * 2;
        const col = quizSelectionIndex % 2;
        const newCol = (col + 1) % 2; 
        quizSelectionIndex = rowStart + newCol;
    }
    
    renderQuizButtons();
}

function updateUI() {
    // Show Progress / Target
    document.getElementById('cleaned-count').innerText = levelProgress + "/" + levelTarget;

    const c = document.getElementById('lives-display'); c.innerHTML = '';
    for(let i=0; i<lives; i++) {
        if (images.heart.complete) {
            let img = document.createElement('img'); img.src = "assets/heart.png"; img.className = 'heart-icon'; c.appendChild(img);
        } else {
            let s = document.createElement('span'); s.style.color='red'; s.innerText='❤️'; c.appendChild(s);
        }
    }
}

function resetGame() { document.getElementById('game-over-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
function nextLevel() { level++; loadLevel(); document.getElementById('level-screen').classList.add('hidden'); gameState = 'PLAYING'; }

/* --- LOOP --- */
window.addEventListener('keydown', (e) => {
    if (gameState === 'QUIZ') {
        e.preventDefault(); 
        if (e.code === 'ArrowUp' || e.code === 'KeyW') changeQuizSelection('UP');
        if (e.code === 'ArrowDown' || e.code === 'KeyS') changeQuizSelection('DOWN');
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') changeQuizSelection('LEFT');
        if (e.code === 'ArrowRight' || e.code === 'KeyD') changeQuizSelection('RIGHT');
        if (e.code === 'Enter' || e.code === 'Space') confirmQuizSelection();
    } 
    else if (gameState === 'MENU') {
        // --- MENU INPUT HANDLER ---
        e.preventDefault();
        if (e.code === 'ArrowUp' || e.code === 'KeyW') changeMenuSelection('UP');
        if (e.code === 'ArrowDown' || e.code === 'KeyS') changeMenuSelection('DOWN');
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') changeMenuSelection('LEFT');
        if (e.code === 'ArrowRight' || e.code === 'KeyD') changeMenuSelection('RIGHT');
        if (e.code === 'Enter' || e.code === 'Space') confirmMenuSelection();
    }
    else if (gameState === 'LEVEL_END') {
        if (e.code === 'Enter' || e.code === 'Space') {
            nextLevel();
        }
    } else {
        handleKey(e, true);
    }
});

function handleKey(e, state) {
    if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = state;
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = state;
    if (e.code === 'ArrowUp' || e.code === 'KeyW' || e.code === 'Space') keys.ArrowUp = state;
}

window.addEventListener('keyup', (e) => {
    if (gameState !== 'QUIZ' && gameState !== 'LEVEL_END' && gameState !== 'MENU') handleKey(e, false);
});

const bindTouch = (id, k) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[k]=true; });
    el.addEventListener('touchend', (e)=>{ e.preventDefault(); keys[k]=false; });
};
bindTouch('btn-left', 'ArrowLeft'); bindTouch('btn-right', 'ArrowRight'); bindTouch('btn-jump', 'ArrowUp');

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    frames++;

    try {
        if (images.background && images.background.complete && images.background.naturalWidth > 0) {
            let bgX = -(cameraX * 0.1) % 800;
            ctx.drawImage(images.background, bgX, 0, 800, 450); ctx.drawImage(images.background, bgX + 800, 0, 800, 450);
        } else { ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,800,450); }

        bgObjects.forEach(obj => obj.draw());
        ctx.fillStyle = '#2c3e50'; platforms.forEach(p => ctx.fillRect(Math.floor(p.x - cameraX), Math.floor(p.y), p.w, p.h));

        if (player) { player.update(); if (player.x > 300) cameraX = player.x - 300; }
        enemies.forEach(e => e.update());
        if (seagullAttack) seagullAttack.update();

        enemies.forEach(e => e.draw());
        if (player) player.draw();
        if (seagullAttack) seagullAttack.draw();

        if (gameState === 'PLAYING') {
            checkCollisions();
        } else if (gameState === 'QUIZ') {
            updateQuizLogic();
        }
    } catch(err) { console.error(err); }

    if (gameState !== 'GAMEOVER' && gameState !== 'LEVEL_END') {
        gameLoopId = requestAnimationFrame(gameLoop);
    } else if (gameState === 'GAMEOVER' || gameState === 'LEVEL_END') {
        gameLoopId = requestAnimationFrame(gameLoop);
    }
}

loadGame();
</script>
</body>
</html>